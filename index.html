<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>For My Cutiepie ‚ù§Ô∏è</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Indie+Flower&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #fff0f3 0%, #ffe4e6 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --primary: #ff758c;
            --secondary: #ff7eb3;
            --text: #4a4a4a;
            --shadow-soft: 0 10px 30px rgba(255, 117, 140, 0.2);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Fredoka', sans-serif;
            background: var(--bg-gradient);
            height: 100vh; width: 100vw;
            overflow: hidden;
            color: var(--text);
        }

        /* --- UI CARD --- */
        .screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; z-index: 10;
        }

        .love-card {
            background: var(--glass-bg);
            border-radius: 25px;
            box-shadow: var(--shadow-soft);
            padding: 2rem; width: 100%; max-width: 420px;
            text-align: center; border: 2px solid white;
            opacity: 0; /* JS handles fade in */
        }

        h1 { font-size: 2rem; color: var(--primary); margin-bottom: 1rem; line-height: 1.2; }
        p { font-size: 1.1rem; color: #666; margin-bottom: 2rem; line-height: 1.5; }

        button {
            background: white; border: 2px solid #ffe4e6;
            padding: 15px; border-radius: 15px; width: 100%; margin-bottom: 10px;
            font-family: 'Fredoka', sans-serif; font-size: 1.1rem; color: var(--text);
            cursor: pointer; transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        button:active { transform: scale(0.98); background: #fff0f3; }

        textarea {
            width: 100%; height: 100px; border: 2px solid #ffe4e6;
            border-radius: 15px; padding: 15px; 
            font-family: 'Indie Flower'; font-size: 1.3rem; 
            margin-bottom: 20px; resize: none; outline: none; background: #fffafa;
        }

        /* --- POPUP --- */
        #popup-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 999;
            backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
        }
        .popup-content {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: var(--shadow-soft); text-align: center; width: 80%; max-width: 300px;
        }
        .popup-text { font-size: 1.4rem; color: var(--primary); margin-bottom: 20px; }
        .next-arrow {
            width: 50px; height: 50px; background: var(--primary); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; margin: 0 auto; cursor: pointer;
        }

        /* --- FINAL ENVELOPE STAGE --- */
        #final-stage { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to top, #fad0c4 0%, #ffd1ff 100%);
            z-index: 100; transform: translateY(100%);
        }

        .envelope-wrapper {
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); /* Centered initially */
            width: 300px; height: 200px;
            cursor: pointer;
        }
        
        .pocket {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            background: #ff758c; border-radius: 0 0 10px 10px; z-index: 20;
            clip-path: polygon(0 0, 50% 50%, 100% 0, 100% 100%, 0 100%);
        }
        .flap {
            position: absolute; top: 0; left: 0; width: 100%; height: 50%;
            background: #ff5c77; border-radius: 10px 10px 0 0; z-index: 30; 
            transform-origin: top; clip-path: polygon(0 0, 100% 0, 50% 100%);
        }
        .seal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 50px; height: 50px; background: gold; border-radius: 50%;
            z-index: 40; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; border: 2px solid #e67e22;
        }

        /* The Card */
        .card-letter {
            position: absolute; top: 10px; left: 15px;
            width: 270px; height: 180px;
            background: white; border-radius: 10px;
            z-index: 15; padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden; /* Hide scrollbars initially */
        }

        .letter-content {
            font-family: 'Indie Flower'; font-size: 1.3rem; 
            color: #444; line-height: 1.6; opacity: 0;
            height: 100%; overflow-y: auto; text-align: left;
        }
        
        .reply-section { margin-top: 30px; border-top: 1px dashed #ccc; padding-top: 20px; text-align: center; }
        .reply-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-family: 'Indie Flower'; font-size: 1.1rem;}
        .reply-btn { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 20px; }

        .hint-text {
            position: absolute; bottom: -50px; width: 100%; text-align: center;
            color: white; font-size: 1.2rem; animation: bounce 1.5s infinite;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .version-tag { position: fixed; bottom: 10px; width: 100%; text-align: center; font-size: 0.8rem; color: rgba(0,0,0,0.3); pointer-events: none; }
    </style>
</head>
<body>

    <div id="popup-overlay">
        <div class="popup-content">
            <div class="popup-text" id="popup-msg"></div>
            <div class="next-arrow" onclick="closePopup()">‚ûú</div>
        </div>
    </div>

    <div id="game-container" class="screen"></div>

    <div id="final-stage">
        <div class="envelope-wrapper" id="envelopeWrapper">
            <div class="flap" id="flap"></div>
            <div class="pocket"></div>
            <div class="seal" id="seal" onclick="openEnvelope()">‚ù§Ô∏è</div>
            <div class="card-letter" id="letterCard">
                <div class="letter-content" id="letterText"></div>
            </div>
            <div class="hint-text" id="hint">Tap to Open</div>
        </div>
        <div class="version-tag">v2.2 | Made with Love</div>
    </div>

<script>
    const SUPABASE_URL = 'https://ezfihigzlgrxidhbulqb.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6ZmloaWd6bGdyeGlkaGJ1bHFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1Mjk1NzMsImV4cCI6MjA4NjEwNTU3M30.sKd1cSawjDQ0JxDiddzhuC_Y-YlqDBK5uosviCImcQo';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let sessionData = { path: [], finalInput: "" };

    const story = {
        start: {
            title: "Hi Cutiepie! ‚ú®",
            text: "If our story was a movie, what genre would it be?",
            options: [
                { text: "A Romantic Comedy üé¨", next: "rom_com" },
                { text: "An Epic Adventure üöÄ", next: "q2" }
            ]
        },
        rom_com: {
            title: "Ooo, Rom-Com?",
            text: "Should I be more romantic than I am now?",
            options: [
                { text: "Yes, sweep me off my feet! üåπ", next: "how_romantic" },
                { text: "You are perfect as you are üíñ", next: "q2", popup: "Aw, you're the best! ü•∞" }
            ]
        },
        how_romantic: {
            title: "How much?",
            text: "Choose your level...",
            options: [
                { text: "Extremely (Possessive & Sweet)", next: "q2", popup: "Noted! Get ready üòâ" },
                { text: "Deep Soul Connection ‚ú®", next: "q2", popup: "My soul is yours. ‚ù§Ô∏è" }
            ]
        },
        q2: {
            title: "Quick Question...",
            text: "How often do you think of me?",
            options: [
                { text: "More than once a day üôà", next: "q3", popup: "I feel lucky üçÄ" },
                { text: "All the time... üí≠", next: "q3", popup: "Come closer then... üòâ" }
            ]
        },
        q3: {
            title: "Almost there...",
            text: "Do you know how much you mean to me?",
            options: [
                { text: "Yes, I know üíï", next: "input_scene" },
                { text: "Tell me again?", action: "finale" }
            ]
        },
        input_scene: {
            title: "Your Turn",
            text: "What kind of person do you want me to be for you?",
            type: "input",
            options: [{ text: "Send & See Surprise üíå", action: "finale" }]
        }
    };

    const fullMessage = `
    My Dearest <span style="color:#ff758c; font-weight:bold;">Puja</span>,<br><br>
    Jab pehli baar hum tumse mile the, tabhi hum jyada kuch jante nahi the tumhare baare mein. Lekin dhire-dhire jab hum dono baat karne lage... honestly, I was scared. Darr lagta tha ki kahin tum gussa na ho jao üòÖ.<br><br>
    But then you called back. And that changed everything.<br><br>
    Pata nahi kab tumhare liye feelings aa gayi. I always knew deep down that you would be mine. Aur ab jab tum meri ho... I promise to love you insanely. <br><br>
    Darr aaj bhi lagta hai‚Äîki kahin tum hurt na ho jao. Because you matter the most to me. Agar kabhi kuch galat bol du, toh daant dena, par roothna mat please?<br><br>
    Happy Propose Day, my love.<br>
    <span style="font-size:1.5rem; color:#ff758c; display:block; margin:10px 0;">I LOVE YOU SO MUCH üíï</span>
    Forever yours,<br>Prabhat
    <div class="reply-section">
        <input type="text" id="finalReply" class="reply-input" placeholder="Type 'I love you too'...">
        <button onclick="sendReply()" class="reply-btn">Send ‚ù§Ô∏è</button>
    </div>
    <div style="margin-top:20px; font-size:0.9rem; color:#999; cursor:pointer;" onclick="location.reload()">‚Ü∫ Start Over</div>
    `;

    const container = document.getElementById('game-container');

    function renderScene(id) {
        const scene = story[id];
        let inputHTML = scene.type === 'input' ? `<textarea id="userInput" placeholder="Write your feelings..."></textarea>` : '';

        container.innerHTML = `
            <div class="love-card">
                <h1>${scene.title}</h1>
                <p>${scene.text}</p>
                ${inputHTML}
                <div class="btn-group">
                    ${scene.options.map((opt, i) => `<button onclick="handleOption('${id}', ${i})">${opt.text}</button>`).join('')}
                </div>
            </div>
        `;
        gsap.fromTo(".love-card", {y: 20, opacity: 0}, {y: 0, opacity: 1, duration: 0.6});
    }

    window.handleOption = (id, idx) => {
        const opt = story[id].options[idx];
        sessionData.path.push({ q: story[id].text, a: opt.text });
        if(opt.popup) openPopup(opt.popup, opt.next, opt.action);
        else proceed(opt.next, opt.action);
    };

    function proceed(nextId, action) {
        const input = document.getElementById('userInput');
        if(input) sessionData.finalInput = input.value;
        if (action === "finale") { saveData(); startFinale(); } 
        else { renderScene(nextId); }
    }

    const popupOverlay = document.getElementById('popup-overlay');
    let pending = null;
    function openPopup(msg, next, action) {
        document.getElementById('popup-msg').innerText = msg;
        pending = { next, action };
        popupOverlay.style.pointerEvents = "auto";
        gsap.to(popupOverlay, { opacity: 1 });
        gsap.fromTo(".popup-content", { scale: 0.8 }, { scale: 1, duration: 0.4, ease: "back.out" });
    }
    window.closePopup = () => {
        gsap.to(popupOverlay, { opacity: 0, onComplete: () => {
            popupOverlay.style.pointerEvents = "none";
            proceed(pending.next, pending.action);
        }});
    };

    function startFinale() {
        gsap.to(container, { y: -50, opacity: 0, duration: 1 });
        gsap.to("#final-stage", { y: '0%', duration: 1, ease: "power2.inOut" });
    }

    window.openEnvelope = () => {
        document.getElementById('hint').style.display = 'none';
        const tl = gsap.timeline();
        
        tl.to("#seal", { scale: 0, duration: 0.3 }) 
          .to("#flap", { rotateX: 180, duration: 0.6, transformOrigin: "top" })
          .set("#flap", { zIndex: 1 })
          .set("#letterCard", { zIndex: 999 }) // FORCE TOP
          
          // 1. Slide Up
          .to("#letterCard", { y: -150, duration: 0.8 })
          
          // 2. The FIX: Switch to FIXED and CENTER using xPercent/yPercent
          .to("#letterCard", {
              position: "fixed",
              top: "50%",
              left: "50%",
              xPercent: -50, // This centers it horizontally
              yPercent: -50, // This centers it vertically
              x: 0, // Clear previous relative transforms
              y: 0,
              width: "90vw",
              height: "80vh",
              duration: 1.2,
              ease: "back.out(0.5)" // Gentle pop
          })
          .call(() => {
              document.getElementById('letterText').innerHTML = fullMessage;
              gsap.to(".letter-content", { opacity: 1, duration: 1 });
              confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 }, colors: ['#ff758c', '#ffd1ff'] });
          });
    };

    async function saveData() {
        await supabaseClient.from('puja_answers').insert([{ question_path: sessionData.path, final_message: sessionData.finalInput }]);
    }
    window.sendReply = async () => {
        const reply = document.getElementById('finalReply').value;
        if(!reply) return;
        const btn = document.querySelector('.reply-btn');
        btn.innerText = "Sending...";
        await supabaseClient.from('puja_answers').insert([{ final_message: "REPLY: " + reply }]);
        btn.innerText = "Sent! ‚ù§Ô∏è";
        btn.style.backgroundColor = "#4cd137";
        confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 } });
    };

    renderScene('start');
</script>
</body>
</html>
